name: Build TTPOS APK

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version name (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
  push:
    tags:
      - 'v*'
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout the code
        uses: actions/checkout@v3
        with:
          submodules: 'true'
          repository: 'innet8/cash-register-system' # 目标仓库的 owner 和名称
          token: ${{ secrets.OTHER_REPO_TOKEN }} # 使用存储在 secrets 中的 token
          ref: 'release' # 可选：指定要检出的分支或 tag，默认为 default branch
      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
          
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 9
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          
      - name: version configuration
        id: config
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            tag=${{ github.ref }}
            new_version=$(echo ${tag} | sed 's/refs\/tags\/v//')
          else
            new_version="${{ github.event.inputs.version }}"
          fi
          new_version_code=$(date +%y%m%d%H)
          jq '.version = "'${new_version}'" | .versionCode = '${new_version_code}'' package.json > tmp.json && mv tmp.json package.json
          cat > src/static/config.js  <<EOF
          window.config = () => {
              return {
                  title: 'TTPOS', // 默认浏览器标题 JBCレジ TTPOS
                  brand: 'ttpos', // 品牌 日本=> jbc, 泰国=>ttpos
                  webLogo: '', // webLogo有值是优先加载Logo 否则按照地区加载默认图标
                  mode: 'saas', // 部署模式 saas=云端部署 or local=局域网部署
                  saasApiUrl: 'cashier.ttpos.com'
              };
          };
          EOF
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "new_version_code=$new_version_code" >> $GITHUB_OUTPUT
          
      - name: Build the MINI
        working-directory: ./app/Mini
        run: |
          pnpm install fs-extra
          pnpm install --no-frozen-lockfile
          npm run build:web-app
          
      - name: Build the Webapp
        run: |
          pnpm install --no-frozen-lockfile
          npm run build:web-app
          ls dist/build/h5/assets
          ls app/JBC/app/src/main/assets/hybrid/assets
      - name: Build the APK
        working-directory: ./app/JBC
        run: |
          chmod +x gradlew
          version=${{ steps.config.outputs.new_version }}
          version_code=${{ steps.config.outputs.new_version_code }}
          ./gradlew assemble "-PCustomCode=${version_code}" "-PVersionName=${version}" "-PPackageTimes=1" 
          #./autoBuild.sh full
          
      - name: Save Build Result
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: |
            app/JBC/app/build/outputs/apk/jbc/release/*.apk
            app/JBC/app/build/outputs/apk/ttpos/release/*.apk
